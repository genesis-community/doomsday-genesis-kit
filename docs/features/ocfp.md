# OCFP Feature

The `ocfp` feature configures Doomsday to deploy according to the Open Cloud Foundry Platform (OCFP) reference architecture.

## Overview

When enabled, the `ocfp` feature:

1. Automatically enables the `tls`, `lb`, and `userpass` features
2. Configures Doomsday to discover and monitor certificates across your OCFP environment
3. Provides integration with BOSH directors, Vault, and FQDNs generated by Terraform

## Configuration

### Enabling the Feature

Add `ocfp` to your environment's feature list:

```yaml
---
features:
- ocfp
```

### Parameters

The following parameters are specific to the OCFP feature:

- `ocfp_env_scale`: Size of the environment (`dev` or `prod`). Affects VM and disk sizing. Defaults to `dev`.

## Behavior

When the `ocfp` feature is enabled, Doomsday will:

1. **Discover BOSH Directors**
   - Look up the BOSH director that deploys it
   - Discover other BOSH directors in the environment
   - Configure to scan all directors' Credhub instances for certificates

2. **Monitor FQDNs**
   - Look up Terraform outputs in Vault at the paths:
     - `<vault_prefix>/tf/<env_path>/mgmt/fqdns`
     - `<vault_prefix>/tf/<env_path>/ocf/fqdns`
   - Configure to scan certificates for all discovered FQDNs

3. **Scan Vault**
   - Monitor certificates in Vault paths
   - Use `sharded-vault-paths` feature if enabled, otherwise use default paths

4. **Integrate with Infrastructure**
   - Configure for deployment behind a load balancer
   - Set up TLS for secure access
   - Enable user authentication

## Implementation Details

The OCFP feature works by generating several dynamic configuration files during the blueprint phase:

1. **Environment FQDN Configuration**
   - Template: `ocfp/templates/fqdns.yml`
   - Output: `dynamic/${env_name}-bosh-fqdns.yml`
   - Purpose: Configure Doomsday to monitor FQDNs from Terraform outputs

2. **BOSH CredhHub Configuration**
   - Template: `ocfp/templates/credhub.yml`
   - Output: `dynamic/${env_name}-bosh-credhub.yml`
   - Purpose: Configure Doomsday to monitor Credhub certificates

3. **Environment Vault Configuration**
   - Template: `ocfp/templates/vault.yml`
   - Output: `dynamic/${env_name}-vault.yml`
   - Purpose: Configure Doomsday to monitor Vault certificates

## Example

Here's an example of an environment file using the OCFP feature:

```yaml
---
# ocfp-deployment.yml

# Network definition
networks:
- name: mgmt-doomsday
  static: [10.0.10.10]

# Required parameters
params:
  ip: 10.0.10.10
  network: mgmt-doomsday
  fqdn: doomsday.mgmt.example.com
  
  # Customize OCFP sizing
  ocfp_env_scale: prod  # Options: dev, prod
  
# Enable OCFP (automatically includes tls, lb, userpass)
features:
- ocfp
```

## Considerations

1. **Vault Access**
   - Doomsday needs appropriate permissions to access Vault paths
   - Ensure the Vault role used has sufficient permissions

2. **BOSH Director Access**
   - Doomsday needs access to BOSH directors and their Credhub instances
   - Ensure network connectivity and proper credentials

3. **Resource Requirements**
   - OCFP environments may monitor a large number of certificates
   - Consider using `ocfp_env_scale: prod` for larger environments